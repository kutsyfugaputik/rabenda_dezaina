const dotenv = require('dotenv').config(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ —Ñ–∞–π–ª–∞ .env
const express = require('express'); // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É express –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞
const path = require('path'); // –ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—É—Ç—è–º–∏ —Ñ–∞–π–ª–æ–≤
const os = require('os'); // –ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–π —Å–∏—Å—Ç–µ–º–æ–π
const { exec } = require('child_process'); // –ú–æ–¥—É–ª—å –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥ –≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ
const fs = require('fs'); // –ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π
const cron = require('node-cron'); // –ú–æ–¥—É–ª—å –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–¥–∞–Ω–∏–π
const sequelize = require('./modules/db'); // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
const cors = require('cors'); // –ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å CORS
const router = require('./routes/index'); // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–∞—Ä—à—Ä—É—Ç—ã –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
const cookieParser = require('cookie-parser'); // –ú–æ–¥—É–ª—å –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ cookies
const logAction = require('./utils/logger'); // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
const ApiError = require('./error/ApiError'); // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–ª–∞—Å—Å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫

const PORT = process.env.PORT || 3000; // –ü–æ–ª—É—á–∞–µ–º –ø–æ—Ä—Ç –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º 3000 –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
const app = express(); // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

logAction('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...', 'üîß'); // –õ–æ–≥–∏—Ä—É–µ–º –Ω–∞—á–∞–ª–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

app.use(cors()); // –†–∞–∑—Ä–µ—à–∞–µ–º –≤—Å–µ –¥–æ–º–µ–Ω—ã –¥–ª—è CORS
app.use(express.json()); // –ú–∏–¥–ª–≤–∞—Ä –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–æ–≤
app.use(cookieParser()); // –ú–∏–¥–ª–≤–∞—Ä –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞ cookies
app.use('/public', express.static(path.join(__dirname, 'public'))); // –°—Ç–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–∞–ø–∫–∞ –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
app.use('/api', router); // –ü–æ–¥–∫–ª—é—á–∞–µ–º –º–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è API

logAction('–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –º–∏–¥–ª–≤–∞—Ä–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞', '‚úÖ'); // –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –º–∏–¥–ª–≤–∞—Ä–æ–≤

// –ü–æ–ª—É—á–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ IP —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º 192.168.0.*
function getLocalExternalIP() {
    logAction('–ó–∞–ø—É—Å–∫ –ø–æ–ª—É—á–µ–Ω–∏—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ IP –∞–¥—Ä–µ—Å–∞...', 'üåê'); // –õ–æ–≥–∏—Ä—É–µ–º –Ω–∞—á–∞–ª–æ –ø–æ–∏—Å–∫–∞ IP

    const interfaces = os.networkInterfaces(); // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å–µ—Ç–µ–≤—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
    logAction(`–ù–∞–π–¥–µ–Ω–æ ${Object.keys(interfaces).length} –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏`, 'üîç'); // –õ–æ–≥–∏—Ä—É–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤

    for (const name of Object.keys(interfaces)) { // –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
        for (const iface of interfaces[name]) { // –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –∫–∞–∂–¥—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            if (iface.family === 'IPv4' && !iface.internal && iface.address.startsWith('192.168.0.')) {
                logAction(`–ù–∞–π–¥–µ–Ω –ª–æ–∫–∞–ª—å–Ω—ã–π IP: ${iface.address}`, '‚úÖ'); // –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω–æ–µ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ IP
                return iface.address; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º IP, –µ—Å–ª–∏ –æ–Ω –≤ –Ω—É–∂–Ω–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ
            }
        }
    }
    // fallback
    logAction('–õ–æ–∫–∞–ª—å–Ω—ã–π IP –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–µ—Ç–∏ 192.168.0.*, –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –æ–±—â–∏–π IP...', '‚ö†Ô∏è'); // –õ–æ–≥–∏—Ä—É–µ–º fallback

    for (const name of Object.keys(interfaces)) { // –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã —Å–Ω–æ–≤–∞ –Ω–∞ —Å–ª—É—á–∞–π fallback
        for (const iface of interfaces[name]) {
            if (iface.family === 'IPv4' && !iface.internal) {
                logAction(`–ù–∞–π–¥–µ–Ω –æ–±—â–∏–π IP: ${iface.address}`, '‚ö†Ô∏è'); // –õ–æ–≥–∏—Ä—É–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–π IP
                return iface.address;
            }
        }
    }

    logAction('–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ IP –∞–¥—Ä–µ—Å. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è localhost.', '‚ö†Ô∏è'); // –õ–æ–≥–∏—Ä—É–µ–º –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ IP
    return 'localhost'; // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º localhost
}

// –§—É–Ω–∫—Ü–∏—è –±—ç–∫–∞–ø–∞ –±–∞–∑—ã
function backupDatabase() {
    logAction('–ó–∞–ø—É—Å–∫ –±—ç–∫–∞–ø–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö...', 'üóÇÔ∏è'); // –õ–æ–≥–∏—Ä—É–µ–º –Ω–∞—á–∞–ª–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –±—ç–∫–∞–ø–∞

    const backupDir = path.join(__dirname, 'backups'); // –ü—É—Ç—å –∫ –ø–∞–ø–∫–µ –¥–ª—è –±—ç–∫–∞–ø–æ–≤
    if (!fs.existsSync(backupDir)) { // –ï—Å–ª–∏ –ø–∞–ø–∫–∞ –¥–ª—è –±—ç–∫–∞–ø–æ–≤ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        fs.mkdirSync(backupDir); // –°–æ–∑–¥–∞–µ–º –µ—ë
        logAction(`–°–æ–∑–¥–∞–Ω–∞ –ø–∞–ø–∫–∞ –¥–ª—è –±—ç–∫–∞–ø–æ–≤: ${backupDir}`, '‚úÖ'); // –õ–æ–≥–∏—Ä—É–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏
    } else {
        logAction('–ü–∞–ø–∫–∞ –¥–ª—è –±—ç–∫–∞–ø–æ–≤ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', '‚ÑπÔ∏è'); // –õ–æ–≥–∏—Ä—É–µ–º, –µ—Å–ª–∏ –ø–∞–ø–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    }

    const timestamp = new Date().toISOString().replace(/[:.]/g, '-'); // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –¥–ª—è –∏–º–µ–Ω–∏ –±—ç–∫–∞–ø–∞
    const backupPath = path.join(backupDir, `backup-${timestamp}.dump`); // –§–æ—Ä–º–∏—Ä—É–µ–º –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –±—ç–∫–∞–ø–∞
    logAction(`–ü—É—Ç—å –∫ —Ñ–∞–π–ª—É –±—ç–∫–∞–ø–∞: ${backupPath}`, 'üìù'); // –õ–æ–≥–∏—Ä—É–µ–º –ø—É—Ç—å –¥–ª—è —Ñ–∞–π–ª–∞ –±—ç–∫–∞–ø–∞

    const pgDumpPath = process.env.PG_DUMP_PATH.replace(/"/g, ''); // –£–±–∏—Ä–∞–µ–º –∫–∞–≤—ã—á–∫–∏ –∏–∑ –ø—É—Ç–∏ –∫ pg_dump
    logAction(`–ò—Å–ø–æ–ª—å–∑—É–µ–º pg_dump –ø—É—Ç—å: ${pgDumpPath}`, 'üîß'); // –õ–æ–≥–∏—Ä—É–µ–º –ø—É—Ç—å –∫ pg_dump

    const dumpCommand = `"${pgDumpPath}" -U ${process.env.DB_USER} -h ${process.env.DB_HOST} -d ${process.env.DB_NAME} -F c -f "${backupPath}"`; // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—É –¥–ª—è –±—ç–∫–∞–ø–∞
    logAction(`–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –±—ç–∫–∞–ø–∞: ${dumpCommand}`, 'üìù'); // –õ–æ–≥–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—É –¥–ª—è –±—ç–∫–∞–ø–∞

    exec(dumpCommand, { env: { ...process.env, PGPASSWORD: process.env.DB_PASSWORD } }, (error, stdout, stderr) => {
        if (error) {
            logAction(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –±—ç–∫–∞–ø–µ: ${error.message}`, '‚ö†Ô∏è'); // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
            return;
        }
        if (stderr) {
            logAction(`‚ö†Ô∏è stderr: ${stderr}`, '‚ö†Ô∏è'); // –õ–æ–≥–∏—Ä—É–µ–º stderr
        }
        logAction(`‚úÖ –ë—ç–∫–∞–ø —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω: ${backupPath}`, 'üóÇÔ∏è'); // –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –±—ç–∫–∞–ø–∞
    });
}

// –ó–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 30 –º–∏–Ω—É—Ç
cron.schedule('*/30 * * * *', () => {
    logAction('–ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –±—ç–∫–∞–ø–∞...', 'üïí'); // –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –±—ç–∫–∞–ø–∞
    backupDatabase(); // –í—ã–ø–æ–ª–Ω—è–µ–º –±—ç–∫–∞–ø
});

// –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
const start = async () => {
    logAction('–ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞...', 'üöÄ'); // –õ–æ–≥–∏—Ä—É–µ–º –Ω–∞—á–∞–ª–æ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞
    try {
        await sequelize.authenticate(); // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
        logAction('‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.', '‚úÖ'); // –õ–æ–≥–∏—Ä—É–µ–º —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
        await sequelize.sync(); // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –º–æ–¥–µ–ª–∏ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
        logAction('‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–∞.', '‚úÖ'); // –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

        app.listen(PORT, () => {
            const IP = getLocalExternalIP(); // –ü–æ–ª—É—á–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π IP
            logAction(`üöÄ –°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç–µ ${PORT}`, '‚úÖ'); // –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
            logAction(`üåê –õ–æ–∫–∞–ª—å–Ω–æ: http://localhost:${PORT}/api/`, 'üåç'); // –õ–æ–≥–∏—Ä—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å
            logAction(`üì° –í —Å–µ—Ç–∏:   http://${IP}:${PORT}/api/`, 'üì°'); // –õ–æ–≥–∏—Ä—É–µ–º —Å–µ—Ç–µ–≤–æ–π –∞–¥—Ä–µ—Å

            logAction('üóÇÔ∏è –ë—ç–∫–∞–ø –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞...', 'üïí'); // –õ–æ–≥–∏—Ä—É–µ–º –∑–∞–ø—É—Å–∫ –±—ç–∫–∞–ø–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞
            backupDatabase(); // –í—ã–ø–æ–ª–Ω—è–µ–º –±—ç–∫–∞–ø –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        });
    } catch (e) {
        logAction(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞: ${e.message}`, '‚ö†Ô∏è'); // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        throw ApiError.internal('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞'); // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É 500 —á–µ—Ä–µ–∑ ApiError
    }
};

start();
