// –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –º–æ–¥—É–ª–∏ –∏ —É—Ç–∏–ª–∏—Ç—ã
const { Masters, Users } = require('../modules/modules'); // –ò–º–ø–æ—Ä—Ç –º–æ–¥–µ–ª–µ–π Masters –∏ Users –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö.
const ApiError = require('../error/ApiError'); // –ö–ª–∞—Å—Å –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ API-–æ—à–∏–±–æ–∫ —Å HTTP —Å—Ç–∞—Ç—É—Å–∞–º–∏.
const bcrypt = require('bcrypt'); // –ü–∞–∫–µ—Ç –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–∞—Ä–æ–ª–µ–π.
const jwt = require('jsonwebtoken'); // –ü–∞–∫–µ—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ JWT-—Ç–æ–∫–µ–Ω–æ–≤.
const logAction = require('..//utils/logger'); // –£—Ç–∏–ª–∏—Ç–∞ –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏–π –≤ —Ñ–∞–π–ª –∏ –∫–æ–Ω—Å–æ–ª—å.
const fs = require('fs'); // –ú–æ–¥—É–ª—å —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã.
const path = require('path'); // –ú–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø—É—Ç—è–º–∏.
const db = require('../modules/db'); // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, –µ—Å–ª–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –ø—Ä—è–º—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤.

class MasterController {
    // –ú–µ—Ç–æ–¥ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –º–∞—Å—Ç–µ—Ä–∞
    async loginMaster(req, res, next) {
        const { email, password } = req.body; // –ü–æ–ª—É—á–∞–µ–º email –∏ –ø–∞—Ä–æ–ª—å –∏–∑ —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞
        logAction(`–ó–∞–ø—Ä–æ—Å –Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –º–∞—Å—Ç–µ—Ä–∞: ${email}`, 'üì•'); // –õ–æ–≥–∏—Ä—É–µ–º –Ω–∞—á–∞–ª–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

        try {
            logAction('–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ email...', 'üîç'); // –õ–æ–≥ –ø–æ–∏—Å–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const user = await Users.findOne({ where: { email } }); // –ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ Users

            if (!user) {
                logAction(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω: ${email}`, '‚ùå'); // –õ–æ–≥ ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω
                throw ApiError.badRequest('–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å'); // –û—à–∏–±–∫–∞ ‚Äî 400
            }

            logAction(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–π–¥–µ–Ω (id=${user.user_id}). –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª—è...`, '‚úÖ'); // –õ–æ–≥ ‚Äî –Ω–∞–π–¥–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
            const isPasswordValid = await bcrypt.compare(password, user.password); // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –≤–≤–µ–¥—ë–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å —Å —Ö–µ—à–µ–º

            if (!isPasswordValid) {
                logAction(`–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${email}`, '‚ùå'); // –õ–æ–≥ ‚Äî –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å
                throw ApiError.badRequest('–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å'); // –û—à–∏–±–∫–∞ ‚Äî 400
            }

            logAction('–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏: –º–∞—Å—Ç–µ—Ä...', 'üîç'); // –õ–æ–≥ ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–∏
            const master = await Masters.findOne({ where: { user_id: user.user_id } }); // –ò—â–µ–º –º–∞—Å—Ç–µ—Ä–∞ –ø–æ user_id

            if (!master) {
                logAction(`–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${user.user_id} –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Ç–µ—Ä–æ–º`, '‚ùå'); // –õ–æ–≥ ‚Äî –Ω–µ –º–∞—Å—Ç–µ—Ä
                throw ApiError.forbidden('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω'); // –û—à–∏–±–∫–∞ ‚Äî 403
            }

            logAction('–ì–µ–Ω–µ—Ä–∞—Ü–∏—è JWT —Ç–æ–∫–µ–Ω–∞...', 'üîê'); // –õ–æ–≥ ‚Äî –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞
            const token = jwt.sign(
                { id: user.user_id, role: 'master' }, // –î–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–æ–∫–µ–Ω–∞
                process.env.JWT_SECRET, // –°–µ–∫—Ä–µ—Ç –¥–ª—è –ø–æ–¥–ø–∏—Å–∏
                { expiresIn: '1h' } // –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ ‚Äî 1 —á–∞—Å
            );

            logAction('–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫—É–∫–∏ —Å —Ç–æ–∫–µ–Ω–æ–º...', 'üç™'); // –õ–æ–≥ ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫—É–∫–∏
            res.cookie('token', token, {
                httpOnly: true, // –¢–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ HTTP
                secure: true, // –¢–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ HTTPS
                sameSite: 'Strict', // –ë–µ–∑ –º–µ–∂—Å–∞–π—Ç–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
                maxAge: 3600000, // –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ ‚Äî 1 —á–∞—Å
            });

            logAction(`–ú–∞—Å—Ç–µ—Ä ${user.user_id} —É—Å–ø–µ—à–Ω–æ –≤–æ—à—ë–ª`, '‚úÖ'); // –õ–æ–≥ ‚Äî —É—Å–ø–µ—Ö
            return res.json({ message: '–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ –º–∞—Å—Ç–µ—Ä–∞' }); // –û—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É
        } catch (error) {
            logAction(`–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –º–∞—Å—Ç–µ—Ä–∞: ${error.message}`, 'üî•'); // –õ–æ–≥ –æ—à–∏–±–∫–∏
            return next(ApiError.internal('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –º–∞—Å—Ç–µ—Ä–∞')); // –û—à–∏–±–∫–∞ 500 —á–µ—Ä–µ–∑ ApiError
        }
    }

    // –ú–µ—Ç–æ–¥ –ø–æ–ª—É—á–µ–Ω–∏—è –≤—Å–µ—Ö –º–∞—Å—Ç–µ—Ä–æ–≤
    async getAll(req, res, next) {
        logAction('–ó–∞–ø—Ä–æ—à–µ–Ω —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –º–∞—Å—Ç–µ—Ä–æ–≤...', 'üìÑ'); // –õ–æ–≥ ‚Äî –Ω–∞—á–∞–ª–æ –∑–∞–ø—Ä–æ—Å–∞

        try {
            const masters = await Masters.findAll(); // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –º–∞—Å—Ç–µ—Ä–æ–≤
            logAction(`–ù–∞–π–¥–µ–Ω–æ –º–∞—Å—Ç–µ—Ä–æ–≤: ${masters.length}`, '‚úÖ'); // –õ–æ–≥ ‚Äî —Å–∫–æ–ª—å–∫–æ –Ω–∞–π–¥–µ–Ω–æ
            return res.json(masters); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–∞—Å—Å–∏–≤ –º–∞—Å—Ç–µ—Ä–æ–≤
        } catch (error) {
            logAction(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –º–∞—Å—Ç–µ—Ä–æ–≤: ${error.message}`, 'üî•'); // –õ–æ–≥ –æ—à–∏–±–∫–∏
            return next(ApiError.internal('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –º–∞—Å—Ç–µ—Ä–æ–≤')); // –û—à–∏–±–∫–∞ 500 —á–µ—Ä–µ–∑ ApiError
        }
    }

    // –ú–µ—Ç–æ–¥ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∏–º–µ—Ä–æ–≤ —Ä–∞–±–æ—Ç –º–∞—Å—Ç–µ—Ä–∞
    async getExampleWorks(req, res, next) {
        try {
            const master_id = req.params.master_id; // –ò–∑–≤–ª–µ–∫–∞–µ–º id –º–∞—Å—Ç–µ—Ä–∞ –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

            if (!master_id) {
                logAction('master_id –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω –≤ –∑–∞–ø—Ä–æ—Å–µ', '‚ùå'); // –õ–æ–≥ ‚Äî –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω id
                throw ApiError.badRequest('master_id –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω'); // –û—à–∏–±–∫–∞ 400
            }

            logAction(`–ó–∞–ø—Ä–æ—Å –Ω–∞ –ø—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç –º–∞—Å—Ç–µ—Ä–∞ —Å id: ${master_id}`, 'üì•'); // –õ–æ–≥ –∑–∞–ø—Ä–æ—Å–∞
            const result = await db.query(
                'SELECT work_examples FROM masters WHERE master_id = $1',
                {
                    bind: [master_id],
                    type: db.QueryTypes.SELECT,
                }
            );

            if (!result || result.length === 0) {
                logAction(`–ú–∞—Å—Ç–µ—Ä —Å id ${master_id} –Ω–µ –Ω–∞–π–¥–µ–Ω`, '‚ùå'); // –õ–æ–≥ ‚Äî –º–∞—Å—Ç–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω
                throw ApiError.notFound('–ú–∞—Å—Ç–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω'); // –û—à–∏–±–∫–∞ 404
            }

            const masterFolderPath = result[0].work_examples; // –ü—É—Ç—å –∫ —Ä–∞–±–æ—Ç–∞–º
            const fullPath = path.resolve(__dirname, '..', masterFolderPath); // –§–æ—Ä–º–∏—Ä—É–µ–º –∞–±—Å–æ–ª—é—Ç–Ω—ã–π –ø—É—Ç—å

            if (!fs.existsSync(fullPath)) {
                logAction(`–ü–∞–ø–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –¥–ª—è –º–∞—Å—Ç–µ—Ä–∞ ${master_id}`, '‚ùå'); // –õ–æ–≥ ‚Äî –ø–∞–ø–∫–∏ –Ω–µ—Ç
                throw ApiError.notFound('–ü–∞–ø–∫–∞ —Å —Ñ–æ—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞'); // –û—à–∏–±–∫–∞ 404
            }

            const files = fs.readdirSync(fullPath); // –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
            if (files.length === 0) {
                logAction(`–§–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ –ø–∞–ø–∫–µ –º–∞—Å—Ç–µ—Ä–∞ ${master_id}`, '‚ùå'); // –õ–æ–≥ ‚Äî –Ω–µ—Ç —Ñ–∞–π–ª–æ–≤
                throw ApiError.notFound('–§–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã'); // –û—à–∏–±–∫–∞ 404
            }

            const imageUrls = files.map(file => {
                return `${req.protocol}://${req.get('host')}/${masterFolderPath}/${file}`; // –§–æ—Ä–º–∏—Ä—É–µ–º URL'—ã
            });

            logAction(`–ü—Ä–∏–º–µ—Ä—ã —Ä–∞–±–æ—Ç –º–∞—Å—Ç–µ—Ä–∞ ${master_id} –∑–∞–≥—Ä—É–∂–µ–Ω—ã`, '‚úÖ'); // –õ–æ–≥ ‚Äî —É—Å–ø–µ—Ö
            res.json({ imageUrls }); // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ URL'–æ–≤
        } catch (error) {
            logAction(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∏–º–µ—Ä–æ–≤ —Ä–∞–±–æ—Ç: ${error.message}`, 'üî•'); // –õ–æ–≥ –æ—à–∏–±–∫–∏
            return next(ApiError.internal('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø—Ä–∏–º–µ—Ä–æ–≤ —Ä–∞–±–æ—Ç')); // –û—à–∏–±–∫–∞ 500 —á–µ—Ä–µ–∑ ApiError
        }
    }
}

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≥–æ—Ç–æ–≤—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞
module.exports = new MasterController();
